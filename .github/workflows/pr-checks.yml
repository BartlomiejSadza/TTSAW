name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest

    steps:
      - name: PR Details
        run: |
          echo "üìã Pull Request: #${{ github.event.pull_request.number }}"
          echo "üìù Title: ${{ github.event.pull_request.title }}"
          echo "üë§ Author: ${{ github.event.pull_request.user.login }}"
          echo "üåø Base: ${{ github.event.pull_request.base.ref }}"
          echo "üîÄ Head: ${{ github.event.pull_request.head.ref }}"

  validate-pr:
    name: Validate PR Requirements
    runs-on: ubuntu-latest

    steps:
      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "Checking PR title: $PR_TITLE"

          # Check if title is not empty and has reasonable length
          if [ ${#PR_TITLE} -lt 10 ]; then
            echo "‚ùå PR title is too short (minimum 10 characters)"
            exit 1
          fi

          if [ ${#PR_TITLE} -gt 100 ]; then
            echo "‚ö†Ô∏è PR title is very long (over 100 characters)"
          fi

          echo "‚úÖ PR title validation passed"

      - name: Check branch name
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "Branch name: $BRANCH"

          # Warn if merging directly from main/master to main/master
          if [[ "$BRANCH" == "main" ]] || [[ "$BRANCH" == "master" ]]; then
            echo "‚ö†Ô∏è Warning: Merging from main/master branch"
          fi

          echo "‚úÖ Branch validation passed"

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [pr-info, validate-pr]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for console.logs in new code
        run: |
          echo "Checking for console.log statements..."

          # This will warn but not fail the build
          if git diff origin/${{ github.event.pull_request.base.ref }} --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -n "console\\.log" || true; then
            echo "‚ö†Ô∏è Warning: Found console.log statements in the code"
            echo "Consider using proper logging in production code"
          else
            echo "‚úÖ No console.log statements found"
          fi

      - name: Check bundle size
        run: |
          npm run build

          # Get .next folder size
          SIZE=$(du -sh .next | cut -f1)
          echo "üì¶ Build size: $SIZE"

          # Warn if build is very large (>100MB)
          SIZE_BYTES=$(du -s .next | cut -f1)
          if [ $SIZE_BYTES -gt 102400 ]; then
            echo "‚ö†Ô∏è Warning: Build size is larger than 100MB"
          else
            echo "‚úÖ Build size is acceptable"
          fi
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/smartoffice
          AUTH_SECRET: test-secret-min-32-characters-long-for-ci
          AUTH_URL: http://localhost:3000

  comment-on-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: success()

    permissions:
      pull-requests: write

    steps:
      - name: Add success comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **All CI checks passed!**\n\n' +
                    '- ‚úÖ Lint and TypeScript check\n' +
                    '- ‚úÖ Build successful\n' +
                    '- ‚úÖ Docker compose build\n\n' +
                    'This PR is ready to be reviewed and merged! üöÄ'
            })
